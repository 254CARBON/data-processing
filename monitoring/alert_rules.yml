# Alert rules for data processing services

groups:
  - name: data-processing-service-alerts
    rules:
      # Service health alerts
      - alert: ServiceDown
        expr: up{job=~"normalization-service|enrichment-service|aggregation-service|projection-service"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "Service {{ $labels.job }} has been down for more than 1 minute."

      - alert: ServiceUnhealthy
        expr: data_processing_service_health_status == 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Service {{ $labels.job }} is unhealthy"
          description: "Service {{ $labels.job }} health check is failing."

      # Performance alerts
      - alert: HighRequestLatency
        expr: histogram_quantile(0.95, rate(data_processing_service_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High request latency detected"
          description: "95th percentile request latency is above 1 second for {{ $labels.job }}."

      - alert: HighErrorRate
        expr: rate(data_processing_service_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          description: "Error rate is above 0.1 errors/second for {{ $labels.job }}."

      # Message processing alerts
      - alert: MessageProcessingLag
        expr: data_processing_service_messages_processed_total{status="failed"} / data_processing_service_messages_processed_total > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High message processing failure rate"
          description: "Message processing failure rate is above 5% for {{ $labels.job }}."

      - alert: NoMessagesProcessed
        expr: rate(data_processing_service_messages_processed_total[10m]) == 0
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "No messages being processed"
          description: "No messages have been processed in the last 10 minutes for {{ $labels.job }}."

      # Resource alerts
      - alert: HighMemoryUsage
        expr: data_processing_service_memory_usage_bytes / 1024 / 1024 / 1024 > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "Memory usage is above 1GB for {{ $labels.job }}."

      - alert: HighCPUUsage
        expr: rate(process_cpu_seconds_total[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is above 80% for {{ $labels.job }}."

  - name: infrastructure-alerts
    rules:
      # Kafka alerts
      - alert: KafkaDown
        expr: up{job="kafka"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Kafka is down"
          description: "Kafka cluster is not responding."

      # Database alerts
      - alert: ClickHouseDown
        expr: up{job="clickhouse"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "ClickHouse is down"
          description: "ClickHouse database is not responding."

      - alert: PostgresDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL database is not responding."

      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis is down"
          description: "Redis cache is not responding."

  - name: data-quality-alerts
    rules:
      # Data quality alerts
      - alert: HighDataQualityIssues
        expr: rate(data_processing_service_messages_processed_total{status="failed"}[5m]) > 0.01
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High data quality issues"
          description: "Data quality issues detected in {{ $labels.job }}."

      - alert: MalformedDataSpike
        expr: rate(data_processing_service_errors_total{error_type="malformed_data"}[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Spike in malformed data"
          description: "High rate of malformed data detected in {{ $labels.job }}."

